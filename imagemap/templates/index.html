<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bild-Karte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      width: 300px;
      background: #f4f4f4;
      padding: 1rem;
      overflow-y: auto;
      height: 100vh;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #map {
      flex: 1;
      height: 100vh;
    }
    .tag-button {
      display: inline-block;
      margin: 3px;
      padding: 8px 12px;
      background-color: #fff;
      border: 1px solid #474747;
      border-radius: 16px;
      color: #000;
      cursor: pointer;
      user-select: none;
    }
    .tag-button:hover {
      background: #ccc;
    }
    button {
      border: 1px solid #06880d;
      background-color: #00ff51;
      border-radius: 16px;
      padding: 10px 20px;
      color: white;
      cursor: pointer;
      user-select: none;
    }
    h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    h4 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .hidden { display: none; }
    label { display: block; margin-bottom: 6px; }
    #uploadWindow {
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      display: none;
      border-radius: 6px;
    }
    textarea {
      width: 100%;
      resize: vertical;
    }
  </style>
</head>
<body>
<div id="sidebar">
    <h3>Seitenleiste</h3>
    <button onclick="toggleUploadWindow()">Neues Bild hochladen</button><br><br>

    <div id="uploadWindow">
      <h4>Bild hochladen</h4>
      <form id="uploadForm">
        <label for="imageInput">Bild:</label>
        <input type="file" id="imageInput" accept="image/*" required><br><br>

        <label for="bildName">Name:</label>
        <input type="text" id="bildName" required><br><br>

        <label for="bildTag">Tag:</label>
        <input type="text" id="bildTag" required><br><br>

        <label for="bildInfo">Zusätzliche Infos:</label>
        <textarea id="bildInfo" rows="3"></textarea><br><br>

        <label><input type="checkbox" id="advMode"> Advanced Mode</label><br><br>

        <div id="coordsInputs" class="hidden">
          <label for="latInput">Breitengrad:</label>
          <input type="text" id="latInput" placeholder="z.B. 51.0504"><br><br>

          <label for="lonInput">Längengrad:</label>
          <input type="text" id="lonInput" placeholder="z.B. 13.7373"><br><br>
        </div>

        <button type="submit">Hochladen</button>
      </form>
    </div>

    <hr>
    <h4>Tags</h4>
    <div id="tagFilter"></div>
    <button onclick="resetFilter()">Alle anzeigen</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([51, 10], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    const blueIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    let markers = [];

    function loadData(tagFilter = null) {
      fetch("/data")
        .then(res => res.json())
        .then(data => {
          markers.forEach(m => map.removeLayer(m));
          markers = [];
          const tags = new Set();

          data.forEach(group => {
            const sorted = group.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            const center = sorted[0];

            if (tagFilter && !sorted.some(b => b.tag === tagFilter)) return;
            sorted.forEach(b => tags.add(b.tag));

            const html = `
              <div style="max-height: 300px; overflow-y: auto; width: 250px;">
                ${sorted.map(bild => `
                  <div style="margin-bottom:10px;">
                    <div><b>${bild.name}</b> — ${new Date(bild.datum).toLocaleString()}</div>
                    <div>${bild.tag} | ${bild.info || ""}</div>
                    <img src="/static/${bild.bildpfad}" style="max-width: 100%; height: auto;" />
                  </div>
                `).join('')}
              </div>`;

            const marker = L.marker([center.lat, center.lon], {icon: blueIcon})
              .bindPopup(html);
            marker.addTo(map);
            markers.push(marker);
          });

          renderTagButtons([...tags]);
        });
    }

    function renderTagButtons(tags) {
      const container = document.getElementById("tagFilter");
      container.innerHTML = "";
      tags.forEach(tag => {
        const btn = document.createElement("span");
        btn.className = "tag-button";
        btn.textContent = tag;
        btn.onclick = () => loadData(tag);
        container.appendChild(btn);
      });
    }

    function resetFilter() {
      loadData(null);
    }

    // Upload-Sidebar

    const uploadWindow = document.getElementById("uploadWindow");
    const advCheckbox = document.getElementById("advMode");
    const coordsInputs = document.getElementById("coordsInputs");

    advCheckbox.addEventListener("change", () => {
      coordsInputs.classList.toggle("hidden", !advCheckbox.checked);
    });

    function toggleUploadWindow() {
      uploadWindow.style.display = uploadWindow.style.display === "block" ? "none" : "block";
    }

    document.getElementById("uploadForm").addEventListener("submit", async e => {
      e.preventDefault();

      const bild = document.getElementById("imageInput").files[0];
      const name = document.getElementById("bildName").value.trim();
      const tag = document.getElementById("bildTag").value.trim();
      const info = document.getElementById("bildInfo").value.trim();
      const adv = advCheckbox.checked;
      const lat = document.getElementById("latInput").value.trim();
      const lon = document.getElementById("lonInput").value.trim();

      if (!bild) {
        alert("Bitte ein Bild auswählen!");
        return;
      }
      if (!name || !tag) {
        alert("Bitte Name und Tag ausfüllen!");
        return;
      }
      if (adv && (!lat || !lon)) {
        alert("Bitte Koordinaten im Advanced Mode ausfüllen!");
        return;
      }

      const formData = new FormData();
      formData.append("bild", bild);
      formData.append("name", name);
      formData.append("tag", tag);
      formData.append("info", info);
      formData.append("adv", adv);
      if (adv) {
        formData.append("lat", lat);
        formData.append("lon", lon);
      }

      try {
        const res = await fetch("/upload", { method: "POST", body: formData });
        const data = await res.json();
        if (res.ok) {
          alert("Bild erfolgreich hochgeladen!");
          toggleUploadWindow();
          document.getElementById("uploadForm").reset();
          coordsInputs.classList.add("hidden");
          loadData();
        } else {
          alert("Fehler: " + (data.error || "Unbekannt"));
        }
      } catch (e) {
        alert("Upload fehlgeschlagen.");
      }
    });

    loadData();
  </script>
</body>
</html>
